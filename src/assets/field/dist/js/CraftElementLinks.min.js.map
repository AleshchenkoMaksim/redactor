{"version":3,"sources":["CraftElementLinks.js"],"names":["plugin","$","extend","Craft","Redactor","PluginBase","linkOptions","existingText","hack","start","showModal","arguments","zIndex","refHandle","callback","criteria","modal","createElementSelectorModal","elementType","storageKey","sources","defaultSiteId","this","elementSiteId","onSelect","proxy","elements","length","element","data","url","id","siteId","text","label","temporary","closeOtherModals","$shade","css","$container","setLinkOptions","onmodal","link","open","form","app","editor","focus","nodes","$form","$formItem","find","val","idx","option","optionTitle","appendTo","on","ev","bind","prepend","close","add"],"mappings":"AAAA,IAAIA,OAASC,EAAEC,OAAO,GAAIC,MAAMC,SAASC,WAAY,CACjDC,YAAa,GACbC,aAAc,GACdC,KAAM,KAGNC,MAAO,aAGPC,UAAW,SAAUC,UAAWC,GAC5B,IAAIC,EAAYF,UAAUE,UACtBC,EAAWH,UAAUG,SAEpBH,UAAUI,WACXJ,UAAUI,SAAW,IAGzBJ,UAAUI,SAAc,IAAI,aAG5B,MAAMC,EAAQb,MAAMc,2BAA2BN,UAAUO,YAAa,CAClEC,WAAY,wBAA0BR,UAAUO,YAChDE,QAAST,UAAUS,QACnBL,SAAUJ,UAAUI,SACpBM,cAAeC,KAAKC,cACpBC,SAAUvB,EAAEwB,OAAM,SAASC,GACvB,GAAIA,EAASC,OAAQ,CACjB,IAAIC,EAAUF,EAAS,GACnBG,EAAO,CACHC,IAAKF,EAAQE,IAAM,IAAMjB,EAAY,IAAMe,EAAQG,GAAK,IAAMH,EAAQI,OACtEC,KAAMX,KAAKf,aAAaoB,OAAS,EAAIL,KAAKf,aAAeqB,EAAQM,OAGzEZ,KAAKa,UACLrB,EAASe,MAEdP,MACHc,kBAAkB,IAGtBpB,EAAMqB,OAAOC,IAAI,SAAU1B,EAAS,GACpCI,EAAMuB,WAAWD,IAAI,SAAU1B,EAAS,IAG5C4B,eAAgB,SAAUlC,GACtBgB,KAAKhB,YAAcA,GAGvBmC,QAAS,CACLC,KAAM,CACFC,KAAM,SAAS3B,EAAO4B,GAElBtB,KAAKd,KAAOQ,EAAM6B,IAAIC,OAAOC,MAC7B/B,EAAM6B,IAAIC,OAAOC,MAAQ,IAAM,KAE/B,MAAMnC,EAASX,EAAEe,EAAMgC,OAAOV,IAAI,UAC9BW,EAAQhD,EAAE2C,EAAKI,OACfE,EAAYjD,EAAE,iFAElBqB,KAAKf,aAAe0C,EAAME,KAAK,oBAAoBC,MAEnD,IAAK,IAAIC,KAAO/B,KAAKhB,YAAa,CAC9B,IAAIgD,EAAShC,KAAKhB,YAAY+C,GAC9BpD,EAAE,oBAAsBqD,EAAOC,YAAc,UAAUC,SAASN,GAAWO,GAAG,QAAS,SAAUC,GAC7FpC,KAAKZ,UAAU,CACXQ,YAAaoC,EAAOpC,YACpBL,UAAWyC,EAAOzC,UAClBO,QAASkC,EAAOlC,QAChBL,SAAUuC,EAAOvC,SACjBD,SAAWe,IACPoB,EAAME,KAAK,mBAAmBC,IAAIvB,EAAKC,KACvCmB,EAAME,KAAK,oBAAoBC,IAAIvB,EAAKI,QAE7CrB,IACL+C,KAAKrC,OAGX2B,EAAMW,QAAQV,IAElBW,MAAO,SAAU7C,GAEbA,EAAM6B,IAAIC,OAAOC,MAAQzB,KAAKd,KAC9Bc,KAAKd,KAAO,UAQzBJ,SADI0D,IAAI,SAAU,oBAAqB9D","file":"CraftElementLinks.min.js","sourcesContent":["var plugin = $.extend({}, Craft.Redactor.PluginBase, {\n    linkOptions: [],\n    existingText: '',\n    hack: null,\n\n    // Do nothing on start.\n    start: function () {\n\n    },\n    showModal: function (arguments, zIndex) {\n        let refHandle = arguments.refHandle,\n            callback = arguments.callback;\n\n        if (!arguments.criteria) {\n            arguments.criteria = {};\n        }\n\n        arguments.criteria['uri'] = ':notempty:';\n\n        // Create a new one each time because Redactor creates a new one and we can't reuse the references.\n        const modal = Craft.createElementSelectorModal(arguments.elementType, {\n            storageKey: 'RedactorInput.LinkTo.' + arguments.elementType,\n            sources: arguments.sources,\n            criteria: arguments.criteria,\n            defaultSiteId: this.elementSiteId,\n            onSelect: $.proxy(function(elements) {\n                if (elements.length) {\n                    let element = elements[0],\n                        data = {\n                            url: element.url + '#' + refHandle + ':' + element.id + '@' + element.siteId,\n                            text: this.existingText.length > 0 ? this.existingText : element.label\n                        };\n\n                    this.temporary =\n                    callback(data);\n                }\n            }, this),\n            closeOtherModals: false,\n        });\n       \n        modal.$shade.css('zIndex', zIndex + 1);\n        modal.$container.css('zIndex', zIndex + 2);\n    },\n\n    setLinkOptions: function (linkOptions) {\n        this.linkOptions = linkOptions;\n    },\n\n    onmodal: {\n        link: {\n            open: function(modal, form) {\n                // Prevent Redactor from aggressively refocusing, when we don't want it to.\n                this.hack = modal.app.editor.focus;\n                modal.app.editor.focus = () => null;\n\n                const zIndex = $(modal.nodes).css('zIndex'),\n                    $form = $(form.nodes),\n                    $formItem = $('<div class=\"form-item form-item-link-select\"><label>Pick a link</label></div>');\n\n                this.existingText = $form.find('input[name=text]').val();\n\n                for (let idx in this.linkOptions) {\n                    let option = this.linkOptions[idx];\n                    $('<div class=\"btn\">' + option.optionTitle + '</div>').appendTo($formItem).on('click', function (ev) {\n                        this.showModal({\n                            elementType: option.elementType,\n                            refHandle: option.refHandle,\n                            sources: option.sources,\n                            criteria: option.criteria,\n                            callback: (data) => {\n                                $form.find('input[name=url]').val(data.url);\n                                $form.find('input[name=text]').val(data.text);\n                            }\n                        }, zIndex);\n                    }.bind(this));\n                }\n\n                $form.prepend($formItem);\n            },\n            close: function (modal) {\n                // Revert the functionality.\n                modal.app.editor.focus = this.hack;\n                this.hack = null;\n            }\n        }\n    }\n});\n\n(function($R) {\n    $R.add('plugin', 'craftElementLinks', plugin);\n})(Redactor);\n"]}